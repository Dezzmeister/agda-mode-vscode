// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Curry = require("rescript/lib/js/curry.js");
var React = require("react");
var $$Promise = require("reason-promise/lib/js/src/js/promise.bs.js");
var Belt_Array = require("rescript/lib/js/belt_Array.js");
var Belt_Option = require("rescript/lib/js/belt_Option.js");
var Body$AgdaModeVscode = require("./Body.bs.js");
var Chan$AgdaModeVscode = require("../../Util/Chan.bs.js");
var Hook$AgdaModeVscode = require("../Hook.bs.js");
var Link$AgdaModeVscode = require("../Component/Link.bs.js");
var View$AgdaModeVscode = require("../View.bs.js");
var Header$AgdaModeVscode = require("./Header.bs.js");
var Prompt$AgdaModeVscode = require("./Prompt.bs.js");
var Keyboard$AgdaModeVscode = require("./Keyboard.bs.js");

function Panel(Props) {
  var onRequest = Props.onRequest;
  var onEventToView = Props.onEventToView;
  var onResponse = Props.onResponse;
  var onEventFromView = Props.onEventFromView;
  var match = React.useState(function () {
        return {
                TAG: 0,
                _0: "Loading ...",
                [Symbol.for("name")]: "Plain"
              };
      });
  var setHeader = match[1];
  var match$1 = React.useState(function () {
        return "";
      });
  var setStatus = match$1[1];
  var match$2 = React.useState(function () {
        return [];
      });
  var setBody = match$2[1];
  var savedHeaderAndBody = React.useRef(undefined);
  var saveHeaderAndBody = function (header, body) {
    savedHeaderAndBody.current = [
      header,
      body
    ];
    
  };
  var match$3 = React.useState(function () {
        
      });
  var setPrompt = match$3[1];
  var prompt = match$3[0];
  var prompting = Belt_Option.isSome(prompt);
  var match$4 = React.useReducer(Keyboard$AgdaModeVscode.reducer, undefined);
  var runInputMethodAction = match$4[1];
  var inputMethodState = match$4[0];
  var setFontSize = (function (n) { document.documentElement.style.setProperty("--agdaMode-buffer-font-size", n + "px"); });
  React.useEffect((function () {
          Chan$AgdaModeVscode.emit(onEventFromView, /* Initialized */0);
          
        }), []);
  var promptResponseResolver = React.useRef(undefined);
  var onSubmit = function (result) {
    return Belt_Option.forEach(promptResponseResolver.current, (function (resolve) {
                  Curry._1(setPrompt, (function (param) {
                          
                        }));
                  Curry._1(resolve, result);
                  promptResponseResolver.current = undefined;
                  
                }));
  };
  var onUpdatePromptIM = function (action) {
    return Chan$AgdaModeVscode.emit(onEventFromView, {
                TAG: 1,
                _0: action,
                [Symbol.for("name")]: "PromptIMUpdate"
              });
  };
  Hook$AgdaModeVscode.recv(onRequest, onResponse, (function (msg) {
          var match = msg._1;
          var value = match.value;
          var placeholder = match.placeholder;
          var body = match.body;
          var header$p = msg._0;
          Curry._1(setHeader, (function (param) {
                  return header$p;
                }));
          Curry._1(setBody, (function (param) {
                  return [];
                }));
          Curry._1(setPrompt, (function (previous) {
                  if (previous === undefined) {
                    return [
                            body,
                            placeholder,
                            value
                          ];
                  }
                  var oldValue = previous[2];
                  if (oldValue !== undefined) {
                    return [
                            body,
                            placeholder,
                            oldValue
                          ];
                  } else {
                    return [
                            body,
                            placeholder,
                            value
                          ];
                  }
                }));
          var match$1 = $$Promise.pending(undefined);
          promptResponseResolver.current = match$1[1];
          return $$Promise.map(match$1[0], (function (x) {
                        if (x !== undefined) {
                          return {
                                  _0: x,
                                  [Symbol.for("name")]: "PromptSuccess"
                                };
                        } else {
                          return /* PromptInterrupted */0;
                        }
                      }));
        }));
  Hook$AgdaModeVscode.on(onEventToView, (function ($$event) {
          if (typeof $$event === "number") {
            onSubmit(undefined);
            Curry._1(setPrompt, (function (param) {
                    
                  }));
            return Belt_Option.forEach(savedHeaderAndBody.current, (function (param) {
                          var body = param[1];
                          var header = param[0];
                          Curry._1(setHeader, (function (param) {
                                  return header;
                                }));
                          return Curry._1(setBody, (function (param) {
                                        return body;
                                      }));
                        }));
          }
          switch ($$event.TAG | 0) {
            case /* Display */0 :
                var body = $$event._1;
                var header = $$event._0;
                onSubmit(undefined);
                saveHeaderAndBody(header, body);
                Curry._1(setHeader, (function (param) {
                        return header;
                      }));
                return Curry._1(setBody, (function (param) {
                              return body;
                            }));
            case /* Append */1 :
                var body$1 = $$event._1;
                var header$1 = $$event._0;
                onSubmit(undefined);
                saveHeaderAndBody(header$1, body$1);
                Curry._1(setHeader, (function (param) {
                        return header$1;
                      }));
                return Curry._1(setBody, (function (old) {
                              return Belt_Array.concat(old, body$1);
                            }));
            case /* SetStatus */2 :
                var text = $$event._0;
                return Curry._1(setStatus, (function (param) {
                              return text;
                            }));
            case /* PromptIMUpdate */3 :
                var text$1 = $$event._0;
                return Curry._1(setPrompt, (function (x) {
                              if (x !== undefined) {
                                return [
                                        x[0],
                                        x[1],
                                        text$1
                                      ];
                              }
                              
                            }));
            case /* InputMethod */4 :
                return Curry._1(runInputMethodAction, $$event._0);
            case /* ConfigurationChange */5 :
                onSubmit(undefined);
                return setFontSize($$event._0);
            
          }
        }));
  var onLinkEvent = Chan$AgdaModeVscode.make(undefined);
  Chan$AgdaModeVscode.on(onLinkEvent, (function ($$event) {
          switch ($$event.TAG | 0) {
            case /* JumpToTarget */0 :
                return Chan$AgdaModeVscode.emit(onEventFromView, {
                            TAG: 2,
                            _0: $$event._0,
                            [Symbol.for("name")]: "JumpToTarget"
                          });
            case /* MouseOver */1 :
            case /* MouseOut */2 :
                return ;
            
          }
        }));
  return React.createElement(Link$AgdaModeVscode.$$Event.Provider.make, Curry._3(Link$AgdaModeVscode.$$Event.Provider.makeProps, onLinkEvent, React.createElement(View$AgdaModeVscode.EventFromView.Provider.make, Curry._3(View$AgdaModeVscode.EventFromView.Provider.makeProps, onEventFromView, React.createElement("section", {
                              className: "agda-mode native-key-bindings",
                              tabIndex: -1
                            }, React.createElement("div", {
                                  className: "agda-mode-header-container"
                                }, React.createElement(Header$AgdaModeVscode.make, {
                                      header: match[0],
                                      status: match$1[0]
                                    }), React.createElement(Prompt$AgdaModeVscode.make, {
                                      inputMethodActivated: Belt_Option.isSome(inputMethodState),
                                      prompt: prompt,
                                      onSubmit: onSubmit,
                                      onUpdatePromptIM: onUpdatePromptIM
                                    }), React.createElement(Keyboard$AgdaModeVscode.make, {
                                      state: inputMethodState,
                                      onInsertChar: (function ($$char) {
                                          return Chan$AgdaModeVscode.emit(onEventFromView, {
                                                      TAG: 0,
                                                      _0: {
                                                        TAG: 0,
                                                        _0: $$char,
                                                        [Symbol.for("name")]: "InsertChar"
                                                      },
                                                      [Symbol.for("name")]: "InputMethod"
                                                    });
                                        }),
                                      onChooseSymbol: (function (symbol) {
                                          return Chan$AgdaModeVscode.emit(onEventFromView, {
                                                      TAG: 0,
                                                      _0: {
                                                        TAG: 1,
                                                        _0: symbol,
                                                        [Symbol.for("name")]: "ChooseSymbol"
                                                      },
                                                      [Symbol.for("name")]: "InputMethod"
                                                    });
                                        }),
                                      prompting: prompting
                                    })), React.createElement(Body$AgdaModeVscode.make, {
                                  items: match$2[0]
                                })), undefined)), undefined));
}

var make = Panel;

exports.make = make;
/* react Not a pure module */

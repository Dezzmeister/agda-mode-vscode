// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Util$AgdaModeVscode = require("../Util/Util.bs.js");
var Config$AgdaModeVscode = require("../Config.bs.js");
var Parser$AgdaModeVscode = require("../Parser/Parser.bs.js");
var Request$AgdaModeVscode = require("../Request.bs.js");
var Json_Encode$JsonCombinators = require("@glennsl/rescript-json-combinators/lib/js/src/Json_Encode.bs.js");
var Connection__Target$AgdaModeVscode = require("./Connection__Target.bs.js");
var Connection__Target__ALS$AgdaModeVscode = require("./Target/ALS/Connection__Target__ALS.bs.js");
var Connection__Target__Agda$AgdaModeVscode = require("./Target/Agda/Connection__Target__Agda.bs.js");
var Connection__Command__Search$AgdaModeVscode = require("./Connection__Command__Search.bs.js");
var Connection__Download__GitHub$AgdaModeVscode = require("./Download/Connection__Download__GitHub.bs.js");

function getFromConfig() {
  var param = {
    commandLineOptions: Config$AgdaModeVscode.Connection.getCommandLineOptions()
  };
  return {
          commandLineOptions: Json_Encode$JsonCombinators.array(function (prim) {
                  return prim;
                })(param.commandLineOptions)
        };
}

var singleton = {
  contents: undefined
};

async function stop() {
  var match = singleton.contents;
  if (match === undefined) {
    return {
            TAG: "Ok",
            _0: undefined,
            [Symbol.for("name")]: "Ok"
          };
  }
  if (match.TAG === "Agda") {
    singleton.contents = undefined;
    await Connection__Target__Agda$AgdaModeVscode.destroy(match._0);
    return {
            TAG: "Ok",
            _0: undefined,
            [Symbol.for("name")]: "Ok"
          };
  }
  singleton.contents = undefined;
  var error = await Connection__Target__ALS$AgdaModeVscode.destroy(match._0);
  if (error.TAG === "Ok") {
    return {
            TAG: "Ok",
            _0: undefined,
            [Symbol.for("name")]: "Ok"
          };
  } else {
    return {
            TAG: "Error",
            _0: {
              TAG: "ALS",
              _0: error._0,
              [Symbol.for("name")]: "ALS"
            },
            [Symbol.for("name")]: "Error"
          };
  }
}

async function start_(target) {
  if (target.TAG === "Agda") {
    var path = target._1;
    var method_1 = [];
    var method_3 = {
      TAG: "FromFile",
      _0: path,
      [Symbol.for("name")]: "FromFile"
    };
    var method = {
      TAG: "ViaPipe",
      _0: path,
      _1: method_1,
      _2: undefined,
      _3: method_3,
      [Symbol.for("name")]: "ViaPipe"
    };
    var error = await Connection__Target__Agda$AgdaModeVscode.make(method);
    if (error.TAG !== "Ok") {
      return {
              TAG: "Error",
              _0: {
                TAG: "Agda",
                _0: error._0,
                _1: path,
                [Symbol.for("name")]: "Agda"
              },
              [Symbol.for("name")]: "Error"
            };
    }
    singleton.contents = {
      TAG: "Agda",
      _0: error._0,
      _1: {
        TAG: "Agda",
        _0: target._0,
        _1: path,
        [Symbol.for("name")]: "Agda"
      },
      [Symbol.for("name")]: "Agda"
    };
    return {
            TAG: "Ok",
            _0: undefined,
            [Symbol.for("name")]: "Ok"
          };
  }
  var method$1 = target._2;
  var agdaVersion = target._1;
  var alsVersion = target._0;
  if (method$1.TAG === "Ok") {
    var error$1 = await Connection__Target__ALS$AgdaModeVscode.make(method$1._0, getFromConfig());
    if (error$1.TAG !== "Ok") {
      return {
              TAG: "Error",
              _0: {
                TAG: "ALS",
                _0: error$1._0,
                [Symbol.for("name")]: "ALS"
              },
              [Symbol.for("name")]: "Error"
            };
    }
    var conn = error$1._0;
    var method$2 = Connection__Target__ALS$AgdaModeVscode.getIPCMethod(conn);
    singleton.contents = {
      TAG: "ALS",
      _0: conn,
      _1: {
        TAG: "ALS",
        _0: alsVersion,
        _1: agdaVersion,
        _2: {
          TAG: "Ok",
          _0: method$2,
          [Symbol.for("name")]: "Ok"
        },
        [Symbol.for("name")]: "ALS"
      },
      [Symbol.for("name")]: "ALS"
    };
    return {
            TAG: "Ok",
            _0: undefined,
            [Symbol.for("name")]: "Ok"
          };
  }
  var path$1 = method$1._0;
  var error$2 = await Connection__Target__ALS$AgdaModeVscode.make({
        TAG: "ViaPipe",
        _0: path$1,
        _1: [],
        _2: undefined,
        _3: {
          TAG: "FromFile",
          _0: path$1,
          [Symbol.for("name")]: "FromFile"
        },
        [Symbol.for("name")]: "ViaPipe"
      }, getFromConfig());
  if (error$2.TAG !== "Ok") {
    return {
            TAG: "Error",
            _0: {
              TAG: "ALS",
              _0: error$2._0,
              [Symbol.for("name")]: "ALS"
            },
            [Symbol.for("name")]: "Error"
          };
  }
  singleton.contents = {
    TAG: "ALS",
    _0: error$2._0,
    _1: {
      TAG: "ALS",
      _0: alsVersion,
      _1: agdaVersion,
      _2: {
        TAG: "Error",
        _0: path$1,
        [Symbol.for("name")]: "Error"
      },
      [Symbol.for("name")]: "ALS"
    },
    [Symbol.for("name")]: "ALS"
  };
  return {
          TAG: "Ok",
          _0: undefined,
          [Symbol.for("name")]: "Ok"
        };
}

async function findCommand(command) {
  var _error = await Connection__Command__Search$AgdaModeVscode.search(command, undefined);
  if (_error.TAG !== "Ok") {
    return {
            TAG: "Error",
            _0: "CannotFindALSorAgda",
            [Symbol.for("name")]: "Error"
          };
  }
  var path = _error._0;
  var error = await Connection__Target$AgdaModeVscode.fromRawPath(path);
  if (error.TAG !== "Ok") {
    return {
            TAG: "Error",
            _0: error._0,
            [Symbol.for("name")]: "Error"
          };
  }
  await Config$AgdaModeVscode.Connection.addAgdaPath(path);
  return await start_(error._0);
}

async function findALSAndAgda() {
  var _error = await findCommand("als");
  if (_error.TAG === "Ok") {
    return {
            TAG: "Ok",
            _0: undefined,
            [Symbol.for("name")]: "Ok"
          };
  } else {
    return await findCommand("agda");
  }
}

async function start(state) {
  var match = singleton.contents;
  if (match !== undefined) {
    return {
            TAG: "Ok",
            _0: undefined,
            [Symbol.for("name")]: "Ok"
          };
  }
  var target = await Connection__Target$AgdaModeVscode.getPicked(state);
  if (target !== undefined) {
    return await start_(target);
  } else {
    return await findALSAndAgda();
  }
}

async function sendRequest(state, request, handler) {
  var encodeRequest = function ($$document, version) {
    var filepath = Parser$AgdaModeVscode.filepath($$document.fileName);
    var libraryPath = Config$AgdaModeVscode.getLibraryPath();
    var highlightingMethod = Config$AgdaModeVscode.Highlighting.getHighlightingMethod();
    var backend = Config$AgdaModeVscode.getBackend();
    return Request$AgdaModeVscode.encode($$document, version, filepath, backend, libraryPath, highlightingMethod, request);
  };
  var match = singleton.contents;
  if (match !== undefined) {
    if (match.TAG === "Agda") {
      var conn = match._0;
      var match$1 = Connection__Target__Agda$AgdaModeVscode.getInfo(conn);
      var path = match$1[1];
      var handler$1 = function (x) {
        return handler(Util$AgdaModeVscode.Result.mapError(x, (function (err) {
                          return {
                                  TAG: "Agda",
                                  _0: err,
                                  _1: path,
                                  [Symbol.for("name")]: "Agda"
                                };
                        })));
      };
      var error = await Connection__Target__Agda$AgdaModeVscode.sendRequest(conn, encodeRequest(state.document, match$1[0]), handler$1);
      if (error.TAG === "Ok") {
        return {
                TAG: "Ok",
                _0: match._1,
                [Symbol.for("name")]: "Ok"
              };
      }
      await stop();
      return {
              TAG: "Error",
              _0: {
                TAG: "Agda",
                _0: error._0,
                _1: path,
                [Symbol.for("name")]: "Agda"
              },
              [Symbol.for("name")]: "Error"
            };
    }
    var conn$1 = match._0;
    var handler$2 = function (x) {
      return handler(Util$AgdaModeVscode.Result.mapError(x, (function (err) {
                        return {
                                TAG: "ALS",
                                _0: err,
                                [Symbol.for("name")]: "ALS"
                              };
                      })));
    };
    var error$1 = await Connection__Target__ALS$AgdaModeVscode.sendRequest(conn$1, encodeRequest(state.document, conn$1.agdaVersion), handler$2);
    if (error$1.TAG === "Ok") {
      return {
              TAG: "Ok",
              _0: match._1,
              [Symbol.for("name")]: "Ok"
            };
    }
    await stop();
    return {
            TAG: "Error",
            _0: {
              TAG: "ALS",
              _0: error$1._0,
              [Symbol.for("name")]: "ALS"
            },
            [Symbol.for("name")]: "Error"
          };
  }
  var error$2 = await start(state);
  if (error$2.TAG === "Ok") {
    return await sendRequest(state, request, handler);
  } else {
    return {
            TAG: "Error",
            _0: error$2._0,
            [Symbol.for("name")]: "Error"
          };
  }
}

function makeAgdaLanguageServerRepo(memento, globalStoragePath) {
  return {
          username: "agda",
          repository: "agda-language-server",
          userAgent: "agda/agda-mode-vscode",
          memento: memento,
          globalStoragePath: globalStoragePath,
          cacheInvalidateExpirationSecs: 86400
        };
}

async function getALSReleaseManifest(state) {
  var match = await Connection__Download__GitHub$AgdaModeVscode.ReleaseManifest.$$fetch(makeAgdaLanguageServerRepo(state.memento, state.globalStorageUri.fsPath));
  var error = match[0];
  if (error.TAG === "Ok") {
    return {
            TAG: "Ok",
            _0: error._0,
            [Symbol.for("name")]: "Ok"
          };
  } else {
    return {
            TAG: "Error",
            _0: {
              TAG: "CannotFetchALSReleases",
              _0: error._0,
              [Symbol.for("name")]: "CannotFetchALSReleases"
            },
            [Symbol.for("name")]: "Error"
          };
  }
}

var Module = {
  start: start,
  stop: stop,
  sendRequest: sendRequest,
  findCommand: findCommand,
  makeAgdaLanguageServerRepo: makeAgdaLanguageServerRepo,
  getALSReleaseManifest: getALSReleaseManifest
};

var $$Error;

var Agda;

var ALS;

var Target;

var URI;

exports.$$Error = $$Error;
exports.Agda = Agda;
exports.ALS = ALS;
exports.Target = Target;
exports.URI = URI;
exports.Module = Module;
exports.start = start;
exports.stop = stop;
exports.sendRequest = sendRequest;
exports.findCommand = findCommand;
exports.makeAgdaLanguageServerRepo = makeAgdaLanguageServerRepo;
exports.getALSReleaseManifest = getALSReleaseManifest;
/* Util-AgdaModeVscode Not a pure module */

// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Caml = require("rescript/lib/js/caml.js");
var Js_array = require("rescript/lib/js/js_array.js");
var Belt_Array = require("rescript/lib/js/belt_Array.js");
var Chan$AgdaModeVscode = require("../Util/Chan.bs.js");
var Util$AgdaModeVscode = require("../Util/Util.bs.js");

function make() {
  return {
          tally: 0,
          allDone: Chan$AgdaModeVscode.make(),
          deferredLastResponses: []
        };
}

function runNonLast(self, handler, response) {
  self.tally = self.tally + 1 | 0;
  handler(response).finally(function () {
        self.tally = self.tally - 1 | 0;
        if (self.tally === 0) {
          return Chan$AgdaModeVscode.emit(self.allDone, undefined);
        }
        
      });
}

function addLast(self, priority, response) {
  Js_array.push([
        priority,
        response
      ], self.deferredLastResponses);
}

function onceDone(self) {
  if (self.tally === 0) {
    return Promise.resolve();
  } else {
    return Chan$AgdaModeVscode.once(self.allDone);
  }
}

async function runLast(self, handler) {
  await onceDone(self);
  var deferredLastResponses = Belt_Array.map(Js_array.sortInPlaceWith((function (x, y) {
              return Caml.int_compare(x[0], y[0]);
            }), self.deferredLastResponses), (function (prim) {
          return prim[1];
        }));
  Js_array.unshift("CompleteHighlightingAndMakePromptReappear", deferredLastResponses);
  await Util$AgdaModeVscode.oneByOne(Belt_Array.map(deferredLastResponses, (function (res) {
              return handler(res);
            })));
}

var Module = {
  make: make,
  addLast: addLast,
  runNonLast: runNonLast,
  runLast: runLast
};

exports.Module = Module;
exports.make = make;
exports.addLast = addLast;
exports.runNonLast = runNonLast;
exports.runLast = runLast;
/* Chan-AgdaModeVscode Not a pure module */

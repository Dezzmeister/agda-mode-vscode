// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Vscode = require("vscode");
var Caml_option = require("rescript/lib/js/caml_option.js");
var Core__Option = require("@rescript/core/lib/js/src/Core__Option.bs.js");
var Util$AgdaModeVscode = require("../Util/Util.bs.js");
var Command$AgdaModeVscode = require("../Command.bs.js");
var Request$AgdaModeVscode = require("../Request.bs.js");
var Response$AgdaModeVscode = require("../Response.bs.js");
var WebviewPanel$AgdaModeVscode = require("../View/WebviewPanel.bs.js");

function make() {
  return {
          queue: [],
          busy: false
        };
}

function kickStart(self) {
  if (self.busy) {
    return ;
  }
  var thunk = self.queue.shift();
  if (thunk !== undefined) {
    self.busy = true;
    thunk().finally(function () {
          self.busy = false;
          kickStart(self);
        });
    return ;
  }
  
}

function push(self, sendRequestAndHandleResponses, request) {
  var match = Util$AgdaModeVscode.Promise_.pending();
  var resolve = match[1];
  var thunk = async function () {
    await sendRequestAndHandleResponses(request);
    return resolve();
  };
  self.queue.push(thunk);
  kickStart(self);
  return match[0];
}

var RequestQueue = {
  make: make,
  push: push
};

function make$1() {
  return {
          display: undefined,
          prompt: undefined
        };
}

function cacheEvent(self, $$event) {
  if (typeof $$event !== "object" || $$event.TAG !== "Display") {
    return ;
  } else {
    self.display = [
      $$event._0,
      $$event._1
    ];
    return ;
  }
}

function cacheRequest(self, $$event, callback) {
  self.prompt = [
    $$event._0,
    $$event._1,
    callback
  ];
}

function clearPrompt(self) {
  self.prompt = undefined;
}

function restore(self, view) {
  var match = self.prompt;
  if (match !== undefined) {
    WebviewPanel$AgdaModeVscode.sendRequest(view, {
          TAG: "Prompt",
          _0: match[0],
          _1: match[1],
          [Symbol.for("name")]: "Prompt"
        }, match[2]);
    return ;
  } else {
    return Core__Option.forEach(self.display, (function (param) {
                  WebviewPanel$AgdaModeVscode.sendEvent(view, {
                        TAG: "Display",
                        _0: param[0],
                        _1: param[1],
                        [Symbol.for("name")]: "Display"
                      });
                }));
  }
}

var ViewCache = {
  make: make$1,
  cacheEvent: cacheEvent,
  cacheRequest: cacheRequest,
  clearPrompt: clearPrompt,
  restore: restore
};

function toString(log) {
  switch (log.TAG) {
    case "CommandDispatched" :
        return " <=== " + Command$AgdaModeVscode.toString(log._0);
    case "CommandHandled" :
        return " ===> " + Command$AgdaModeVscode.toString(log._0);
    case "RequestSent" :
        return "   <- " + Request$AgdaModeVscode.toString(log._0);
    case "ResponseHandled" :
        return "    > " + Response$AgdaModeVscode.toString(log._0);
    case "Others" :
        return log._0;
    
  }
}

var Log = {
  toString: toString
};

var Any = {};

function make$2(memento) {
  if (memento !== undefined) {
    return {
            TAG: "Memento",
            _0: Caml_option.valFromOption(memento),
            [Symbol.for("name")]: "Memento"
          };
  } else {
    return {
            TAG: "Mock",
            _0: {},
            [Symbol.for("name")]: "Mock"
          };
  }
}

function get(context, key) {
  if (context.TAG === "Memento") {
    return context._0.get(key);
  } else {
    return context._0[key];
  }
}

function getWithDefault(context, key, defaultValue) {
  if (context.TAG === "Memento") {
    return context._0.get(key, defaultValue);
  }
  var value = context._0[key];
  if (value !== undefined) {
    return Caml_option.valFromOption(value);
  } else {
    return defaultValue;
  }
}

function keys(context) {
  if (context.TAG === "Memento") {
    return context._0.keys();
  } else {
    return Object.keys(context._0);
  }
}

function set(context, key, value) {
  if (context.TAG === "Memento") {
    return context._0.update(key, value);
  } else {
    return Promise.resolve((context._0[key] = value, undefined));
  }
}

function toString$1(context) {
  if (context.TAG === "Memento") {
    var context$1 = context._0;
    var entries = context$1.keys().map(function (key) {
          var value = context$1.get(key);
          if (value !== undefined) {
            return key + ": " + Caml_option.valFromOption(value);
          } else {
            return key + ": None";
          }
        });
    return "Memento: {\n" + entries.join("\n") + "}";
  }
  var entries$1 = Object.entries(context._0).map(function (param) {
        return param[0] + ": " + String(param[1]);
      });
  return "Mock: {\n" + entries$1.join("\n") + "}";
}

var Memento = {
  make: make$2,
  get: get,
  getWithDefault: getWithDefault,
  keys: keys,
  set: set,
  toString: toString$1
};

function setPrompt(value) {
  Vscode.commands.executeCommand("setContext", "agdaModePrompting", value);
}

function setIM(value) {
  Vscode.commands.executeCommand("setContext", "agdaModeTyping", value);
}

var Context = {
  setPrompt: setPrompt,
  setIM: setIM
};

exports.RequestQueue = RequestQueue;
exports.ViewCache = ViewCache;
exports.Log = Log;
exports.Any = Any;
exports.Memento = Memento;
exports.Context = Context;
/* vscode Not a pure module */

// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Vscode = require("vscode");
var Js_array = require("rescript/lib/js/js_array.js");
var Caml_option = require("rescript/lib/js/caml_option.js");
var Core__Option = require("@rescript/core/lib/js/src/Core__Option.bs.js");
var IM$AgdaModeVscode = require("./InputMethod/IM.bs.js");
var Chan$AgdaModeVscode = require("./Util/Chan.bs.js");
var State$AgdaModeVscode = require("./State.bs.js");
var Config$AgdaModeVscode = require("./Config.bs.js");
var Editor$AgdaModeVscode = require("./Editor.bs.js");
var Parser$AgdaModeVscode = require("./Parser/Parser.bs.js");
var Tokens$AgdaModeVscode = require("./Tokens.bs.js");
var Command$AgdaModeVscode = require("./Command.bs.js");
var Registry$AgdaModeVscode = require("./Registry.bs.js");
var Singleton$AgdaModeVscode = require("./View/Singleton.bs.js");
var State__View$AgdaModeVscode = require("./State/State__View.bs.js");
var Highlighting$AgdaModeVscode = require("./Highlighting.bs.js");
var WebviewPanel$AgdaModeVscode = require("./View/WebviewPanel.bs.js");
var State__Command$AgdaModeVscode = require("./State/State__Command.bs.js");
var State__InputMethod$AgdaModeVscode = require("./State/State__InputMethod.bs.js");
var Highlighting__SemanticToken$AgdaModeVscode = require("./Highlighting/Highlighting__SemanticToken.bs.js");

function isAgda(fileName) {
  var fileName$1 = Parser$AgdaModeVscode.filepath(fileName);
  return /\.agda$|\.lagda/i.test(fileName$1);
}

function onOpenEditor(callback) {
  Core__Option.forEach(Vscode.window.activeTextEditor, callback);
  return Vscode.window.onDidChangeActiveTextEditor(function (next) {
              Core__Option.forEach(next, callback);
            });
}

function onCloseDocument(callback) {
  return Vscode.workspace.onDidCloseTextDocument(callback);
}

function onTriggerCommand(callback) {
  return Command$AgdaModeVscode.names.map(function (param) {
              var command = param[0];
              return Vscode.commands.registerCommand("agda-mode." + param[1], (function () {
                            return Core__Option.map(Vscode.window.activeTextEditor, (function (editor) {
                                          var fileName = Parser$AgdaModeVscode.filepath(editor.document.fileName);
                                          if (isAgda(fileName)) {
                                            return callback(command, editor);
                                          } else {
                                            return Promise.resolve(undefined);
                                          }
                                        }));
                          }));
            });
}

var Inputs = {
  onOpenEditor: onOpenEditor,
  onCloseDocument: onCloseDocument,
  onTriggerCommand: onTriggerCommand
};

function initialize(debugChan, extensionPath, globalStoragePath, editor, fileName) {
  var panel = Singleton$AgdaModeVscode.Panel.make(extensionPath);
  WebviewPanel$AgdaModeVscode.onceDestroyed(panel).finally(function () {
        Registry$AgdaModeVscode.removeAndDestroyAll();
      });
  var state = State$AgdaModeVscode.make(debugChan, globalStoragePath, extensionPath, editor);
  Chan$AgdaModeVscode.once(state.onRemoveFromRegistry).finally(function () {
        Registry$AgdaModeVscode.remove(fileName);
      });
  var subscribe = function (disposable) {
    Js_array.push(disposable, state.subscriptions);
  };
  var getCurrentEditor = function () {
    var editor = Vscode.window.activeTextEditor;
    if (editor !== undefined) {
      return Caml_option.some(Caml_option.valFromOption(editor));
    } else {
      return Vscode.window.visibleTextEditors[0];
    }
  };
  subscribe(WebviewPanel$AgdaModeVscode.onEvent(State__View$AgdaModeVscode.Panel.get(state), (function ($$event) {
              var editor$p = getCurrentEditor();
              if (editor$p === undefined) {
                return ;
              }
              var fileName$p = Parser$AgdaModeVscode.filepath(Caml_option.valFromOption(editor$p).document.fileName);
              if (fileName$p === fileName) {
                State__Command$AgdaModeVscode.dispatchCommand(state, {
                      TAG: "EventFromView",
                      _0: $$event,
                      [Symbol.for("name")]: "EventFromView"
                    });
                return ;
              }
              
            })));
  subscribe(Vscode.window.onDidChangeTextEditorSelection(function ($$event) {
            var $$document = editor.document;
            var intervals = $$event.selections.map(function (selection) {
                  return [
                          Editor$AgdaModeVscode.Position.toOffset($$document, selection.start),
                          Editor$AgdaModeVscode.Position.toOffset($$document, selection.end)
                        ];
                });
            State__InputMethod$AgdaModeVscode.select(state, intervals);
          }));
  subscribe(Vscode.workspace.onDidChangeTextDocument(function ($$event) {
            var changes = IM$AgdaModeVscode.Input.fromTextDocumentChangeEvent(editor, $$event);
            State__InputMethod$AgdaModeVscode.keyUpdateEditorIM(state, changes);
          }));
  subscribe(Editor$AgdaModeVscode.Provider.registerDefinitionProvider(function (fileName, position) {
            var currentFileName = Parser$AgdaModeVscode.filepath(state.document.fileName);
            var normalizedFileName = Parser$AgdaModeVscode.filepath(fileName);
            var offset = Editor$AgdaModeVscode.Position.toOffset(state.document, position);
            if (normalizedFileName === currentFileName) {
              return Tokens$AgdaModeVscode.lookupSrcLoc(state.tokens, offset);
            }
            
          }));
  return state;
}

function registerDocumentSemanticTokensProvider() {
  var tokenTypes = Highlighting__SemanticToken$AgdaModeVscode.TokenType.enumurate;
  var tokenModifiers = Highlighting__SemanticToken$AgdaModeVscode.TokenModifier.enumurate;
  var provideDocumentSemanticTokens = function ($$document, _cancel) {
    var useSemanticHighlighting = Config$AgdaModeVscode.Highlighting.getHighlightWithThemeColors();
    var fileName = Parser$AgdaModeVscode.filepath($$document.fileName);
    if (useSemanticHighlighting) {
      return Caml_option.some(Registry$AgdaModeVscode.requestSemanticTokens(fileName).then(function (tokens) {
                      var semanticTokensLegend = new Vscode.SemanticTokensLegend(tokenTypes, tokenModifiers);
                      var builder = new Vscode.SemanticTokensBuilder(semanticTokensLegend);
                      tokens.forEach(function (param) {
                            builder.push(Highlighting__SemanticToken$AgdaModeVscode.Module.SingleLineRange.toVsCodeRange(param.range), Highlighting__SemanticToken$AgdaModeVscode.TokenType.toString(param.type_), Core__Option.map(param.modifiers, (function (xs) {
                                        return xs.map(Highlighting__SemanticToken$AgdaModeVscode.TokenModifier.toString);
                                      })));
                          });
                      return builder.build();
                    }));
    }
    
  };
  return Editor$AgdaModeVscode.Provider.registerDocumentSemanticTokensProvider(provideDocumentSemanticTokens, [
              tokenTypes,
              tokenModifiers
            ]);
}

function finalize(isRestart) {
  if (Registry$AgdaModeVscode.isEmpty()) {
    Singleton$AgdaModeVscode.Panel.destroy();
    if (!isRestart) {
      return Singleton$AgdaModeVscode.DebugBuffer.destroy();
    } else {
      return ;
    }
  }
  
}

function activateWithoutContext(subscriptions, extensionPath, globalStoragePath) {
  var channels_inputMethod = Chan$AgdaModeVscode.make();
  var channels_responseHandled = Chan$AgdaModeVscode.make();
  var channels = {
    inputMethod: channels_inputMethod,
    responseHandled: channels_responseHandled
  };
  var x = onOpenEditor(function (editor) {
        var fileName = Parser$AgdaModeVscode.filepath(editor.document.fileName);
        if (isAgda(fileName)) {
          return Core__Option.forEach(Registry$AgdaModeVscode.get(fileName), (function (state) {
                        state.editor = editor;
                        state.document = editor.document;
                        State__Command$AgdaModeVscode.dispatchCommand(state, "Refresh");
                      }));
        }
        
      });
  Js_array.push(x, subscriptions);
  var x$1 = Vscode.workspace.onDidChangeTextDocument(function ($$event) {
        var $$document = $$event.document;
        var fileName = Parser$AgdaModeVscode.filepath($$document.fileName);
        if (isAgda(fileName)) {
          return Core__Option.forEach(Registry$AgdaModeVscode.get(fileName), (function (state) {
                        Highlighting$AgdaModeVscode.updateSemanticHighlighting(state.highlighting, $$event);
                      }));
        }
        
      });
  Js_array.push(x$1, subscriptions);
  var x$2 = Vscode.workspace.onDidCloseTextDocument(function ($$document) {
        var fileName = Parser$AgdaModeVscode.filepath($$document.fileName);
        if (isAgda(fileName)) {
          Registry$AgdaModeVscode.removeAndDestroy(fileName);
          finalize(false);
          return ;
        }
        
      });
  Js_array.push(x$2, subscriptions);
  var xs = onTriggerCommand(async function (command, editor) {
        var fileName = Parser$AgdaModeVscode.filepath(editor.document.fileName);
        if (typeof command !== "object") {
          switch (command) {
            case "Quit" :
                await Registry$AgdaModeVscode.removeAndDestroy(fileName);
                finalize(false);
                break;
            case "Restart" :
                await Registry$AgdaModeVscode.removeAndDestroy(fileName);
                finalize(true);
                break;
            default:
              
          }
        }
        var exit = 0;
        if (typeof command !== "object") {
          switch (command) {
            case "Load" :
            case "Restart" :
                exit = 1;
                break;
            default:
              
          }
        } else if (command.TAG === "InputMethod") {
          var tmp = command._0;
          if (typeof tmp !== "object" && tmp === "Activate") {
            exit = 1;
          }
          
        }
        if (exit === 1) {
          var match = Registry$AgdaModeVscode.get(fileName);
          if (match === undefined) {
            var state = initialize(channels, extensionPath, globalStoragePath, editor, fileName);
            Registry$AgdaModeVscode.add(fileName, state);
          }
          
        }
        var state$1 = Registry$AgdaModeVscode.get(fileName);
        if (state$1 === undefined) {
          return ;
        }
        var error = await State__Command$AgdaModeVscode.dispatchCommand(state$1, command);
        if (error.TAG === "Ok") {
          return {
                  TAG: "Ok",
                  _0: state$1,
                  [Symbol.for("name")]: "Ok"
                };
        } else {
          return {
                  TAG: "Error",
                  _0: error._0,
                  [Symbol.for("name")]: "Error"
                };
        }
      });
  Js_array.pushMany(xs, subscriptions);
  var x$3 = registerDocumentSemanticTokensProvider();
  Js_array.push(x$3, subscriptions);
  return channels;
}

function activate(context) {
  var subscriptions = context.subscriptions;
  var extensionPath = context.extensionPath;
  var globalStoragePath = context.globalStoragePath;
  return activateWithoutContext(subscriptions, extensionPath, globalStoragePath);
}

function deactivate() {
  
}

exports.isAgda = isAgda;
exports.Inputs = Inputs;
exports.initialize = initialize;
exports.registerDocumentSemanticTokensProvider = registerDocumentSemanticTokensProvider;
exports.finalize = finalize;
exports.activateWithoutContext = activateWithoutContext;
exports.activate = activate;
exports.deactivate = deactivate;
/* vscode Not a pure module */

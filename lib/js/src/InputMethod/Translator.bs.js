// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Caml = require("rescript/lib/js/caml.js");
var Core__Int = require("@rescript/core/lib/js/src/Core__Int.bs.js");
var Core__Option = require("@rescript/core/lib/js/src/Core__Option.bs.js");
var Json_Decode$JsonCombinators = require("@glennsl/rescript-json-combinators/lib/js/src/Json_Decode.bs.js");
var Json_Encode$JsonCombinators = require("@glennsl/rescript-json-combinators/lib/js/src/Json_Encode.bs.js");
var QueryJs = require("./../../../../asset/query.js").default;
var KeymapJs = require("./../../../../asset/keymap.js").default;

var rawTable = QueryJs;

var rawKeymapObject = KeymapJs;

function fromObject(obj) {
  var symbols = (obj[">>"] || []);
  var subTrie = Object.fromEntries(Object.keys(obj).filter(function (key) {
              return key !== ">>";
            }).map(function (key) {
            return [
                    key,
                    fromObject((obj[key]))
                  ];
          }));
  return {
          symbols: symbols,
          subTrie: subTrie
        };
}

var keymap = fromObject(rawKeymapObject);

function toKeySuggestions(trie) {
  return Object.keys(trie.subTrie);
}

function toCandidateSymbols(trie) {
  return trie.symbols;
}

function isInKeymap(input) {
  var _input = input;
  var _trie = keymap;
  while(true) {
    var trie = _trie;
    var input$1 = _input;
    var n = input$1.length;
    if (n === 0) {
      return trie;
    }
    var key = input$1.substring(0, 1);
    var rest = input$1.substring(1, n);
    var trie$p = trie.subTrie[key];
    if (trie$p === undefined) {
      return ;
    }
    _trie = trie$p;
    _input = rest;
    continue ;
  };
}

function translate(input, state) {
  var trie = isInKeymap(input);
  var keySuggestions = Core__Option.mapOr(trie, [], toKeySuggestions);
  var further = keySuggestions.length !== 0;
  var candidateSymbols = Core__Option.mapOr(trie, [], toCandidateSymbols);
  var symbol = candidateSymbols[0];
  var last = Core__Int.fromString(input.slice(-1), undefined);
  if (!(Core__Option.isSome(last) && symbol === undefined && Core__Option.isSome(state) && Core__Option.getExn(state, undefined).lastTranslation.candidateSymbols.length !== 0)) {
    return {
            symbol: symbol,
            further: further,
            keySuggestions: keySuggestions,
            candidateSymbols: candidateSymbols
          };
  }
  var state$1 = Core__Option.getExn(state, undefined);
  var cycle_Zplus = function (n) {
    if (n === 0) {
      return 9;
    } else {
      return n - 1 | 0;
    }
  };
  var index = cycle_Zplus(Core__Option.getExn(last, undefined)) + Math.imul(state$1.candidateIndex / 10 | 0, 10) | 0;
  return {
          symbol: state$1.lastTranslation.candidateSymbols[Caml.int_min(index, state$1.lastTranslation.candidateSymbols.length - 1 | 0)],
          further: further,
          keySuggestions: keySuggestions,
          candidateSymbols: candidateSymbols
        };
}

function initialTranslation(x) {
  return translate("", x);
}

function lookup(symbol) {
  return Core__Option.flatMap(Core__Option.map(symbol.codePointAt(0), (function (prim) {
                    return String(prim);
                  })), (function (extra) {
                return rawTable[extra];
              }));
}

var decode = Json_Decode$JsonCombinators.object(function (field) {
      return {
              symbol: field.required("symbol", Json_Decode$JsonCombinators.option(Json_Decode$JsonCombinators.string)),
              further: field.required("further", Json_Decode$JsonCombinators.bool),
              keySuggestions: field.required("keySuggestions", Json_Decode$JsonCombinators.array(Json_Decode$JsonCombinators.string)),
              candidateSymbols: field.required("candidateSymbols", Json_Decode$JsonCombinators.array(Json_Decode$JsonCombinators.string))
            };
    });

function encode(translation) {
  return {
          symbol: Json_Encode$JsonCombinators.option(function (prim) {
                  return prim;
                })(translation.symbol),
          further: translation.further,
          keySuggestions: Json_Encode$JsonCombinators.array(function (prim) {
                  return prim;
                })(translation.keySuggestions),
          candidateSymbols: Json_Encode$JsonCombinators.array(function (prim) {
                  return prim;
                })(translation.candidateSymbols)
        };
}

exports.rawTable = rawTable;
exports.rawKeymapObject = rawKeymapObject;
exports.fromObject = fromObject;
exports.keymap = keymap;
exports.toKeySuggestions = toKeySuggestions;
exports.toCandidateSymbols = toCandidateSymbols;
exports.isInKeymap = isInKeymap;
exports.translate = translate;
exports.initialTranslation = initialTranslation;
exports.lookup = lookup;
exports.decode = decode;
exports.encode = encode;
/* rawTable Not a pure module */
